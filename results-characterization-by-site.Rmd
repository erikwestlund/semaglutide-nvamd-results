---
title: "Semaglutide DR Results Characterization By Site"
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DBI)
library(glue)
library(kableExtra)
library(RPostgres)
library(dplyr)
library(stringr)
library(tidyr)
library(xlsx)

if(!file.exists("env.R")) stop("env.R not found")

source("env.R")

cacheAllBaselineChars <- FALSE

# Notes on table prefixes:
# https://ohdsi.github.io/ShinyAppBuilder/
# cd_ = DefaultCohortDiagnostics table prefix
# cg = Cohort Table Prefix
# c = Default Characterization Prefix 
# plp = Patient Level Prediction
# cm = Cohort Method prefix
# 

# Create postgres connection
con <- DBI::dbConnect(RPostgres::Postgres(), dbname = db_name, host = db_host, port = db_port, user = db_user, password = db_password,   options=paste0("-c search_path=", db_schema))

# List tables in schema
tables <- DBI::dbListTables(con, schema = db_schema)

# Database meta data and c
dbMeta <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  filter(cdm_source_abbreviation == cdmSourceAbbrev)

databaseId <- dbMeta$database_id
```

## Databases Available

```{r databases, echo=FALSE}
databases <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  select(cdm_source_name, cdm_source_abbreviation, cdm_holder, database_id) 

databases |> kable()
```


## Database nicknames

We will map long database names to short ones for publication. Please confirm these are right.

```{r database_nicknames, echo=FALSE}

dbMap <- list(
  "Epic Legacy CUMC MERGE" = "CUMC",
  "JHME" = "JHME",
  "Merative CCAE" = "CCAE",
  "Merative MDCD" = "MDCD",
  "Merative MDCR" = "MDCR",
  "OHSU" = "OHSU",
  "Optum EHR" = "Optum® EHR",
  "OPTUM Extended SES" = "Clinformatics®",
  "PharMetrics" = "PharMetrics",
  "STARR" = "STARR",
  "USC" = "USC",
  "VA-OMOP" = "VA",
  "WashU" = "WU",
  "LRx-US9-LAAD 202405" = "IQVIA"
)

# Make df. key = col 1, val = col 2. remove row names
dbMapDf <- data.frame(
  long = names(dbMap),
  short = unlist(dbMap)
)

dbMapDf |> kable(row.names = FALSE)

# Merge in short name
databases <- databases |> 
  left_join(dbMapDf, by = c("cdm_source_abbreviation" = "long")) |> 
  rename(database_short_name = short)


dbMapOrder <- list(
  "Epic Legacy CUMC MERGE" = 3,
  "LRx-US9-LAAD 202405" = 4,
  "JHME" = 5,
  "Merative CCAE" = 1,
  "Merative MDCD" = 6,
  "Merative MDCR" = 7,
  "OHSU" = 8,
  "Optum EHR" = 9,
  "OPTUM Extended SES" = 2,
  "PharMetrics" = 10,
  "STARR" = 11,
  "USC" = 12,
  "VA-OMOP" = 13,
  "WashU" = 14
)

dbOrderDf <- data.frame(
  long = names(dbMapOrder),
  order = unlist(dbMapOrder)
)

databases <- databases |> 
  left_join(dbOrderDf, by = c("cdm_source_abbreviation" = "long")) |> 
  arrange(order)

```

## All Cohort Definitions in the Database

```{r cohort_definition_info, echo=FALSE}
allCohortDefinitions <- DBI::dbGetQuery(con, "SELECT * FROM cg_cohort_definition") |> 
  select(cohort_definition_id, cohort_name) 

 allCohortDefinitions |> kable()
```

# Cohorts in Table 1

We want to show data on patients who enter between 2017 and before 2023. The cohort definition IDs align with those in the package, but have a suffix of 001.

*Note:* These cohorts are not defined in the study package, but exist in the database. Do we need to document how these are run somewhere?

We are going to select:

* Prior T2DM
* Prior metformin
* Drug exposure:
  * Semaglutide (GLP-1 RA)
  * Dulaglutide (GLP-1 RA)
  * Exenatide (GLP-1 RA)
  * Empagliflozin (SGLT2 inhibitor)
  * Sitagliptin (DPP4 inhibitor)
  * Glipizide (sulfonylurea)
* Drug used as 2nd-line treatment

These can be changed.

```{r cohorts_chosen, echo=FALSE}
cohortIds <- c(
 "Semaglutide (GLP-1 RA)" = 201001,
 "Dulaglutide (GLP-1 RA)" = 211001,	
 "Exenatide (GLP-1 RA)" = 212001,
 "Empagliflozin (SGLT2 inhibitor)" = 213001,
 "Sitagliptin (DPP4 inhibitor)" = 214001,
 "Glipizide (sulfonylurea)" = 215001
)


restrictedCohortDefs <- allCohortDefinitions |> 
  filter(cohort_definition_id %in% cohortIds)

restrictedCohortDefs |> kable()
```

## Available Covariates 

This is filtered to the selected database.

```{r available-cohort-covariates, echo=FALSE}
availableCovariates <- DBI::dbGetQuery(con, "SELECT * FROM c_analysis_ref") |> 
  filter(database_id == databaseId) |> 
  arrange(domain_id)

availableCovariates |> kable()
```

## Baseline Characteristics - Table 1 - Optum SES

```{r all_categorical_baseline_characteristics_all_databases, echo=FALSE}

categoricalCharacterizationSql <- "
SELECT
	cov.database_id,
	cov.run_id,
	t.cohort_definition_id as target_cohort_definition_id,
	t.cohort_name target_cohort_name,
	d.cdm_source_abbreviation,
	cref.covariate_name,
	cov.cohort_definition_id as covariate_cohort_definition_id,
	cov.covariate_id,
	cref.analysis_id,
	cov.sum_value,
	cov.average_value
FROM
	semanaion.c_covariates cov
	INNER JOIN semanaion.c_cohort_details cd ON cd.cohort_definition_id = cov.cohort_definition_id
		AND cd.database_id = cov.database_id
		AND cd.cohort_type = 'T'
	INNER JOIN semanaion.cg_cohort_definition t ON t.cohort_definition_id = cd.target_cohort_id
	INNER JOIN semanaion.c_covariate_ref cref ON cov.covariate_id = cref.covariate_id
		AND cov.database_id = cref.database_id
	INNER JOIN semanaion.database_meta_data d ON d.database_id = cov.database_id
	INNER JOIN semanaion.c_cohort_counts cc ON cov.cohort_definition_id = cc.cohort_definition_id
		AND cov.database_id = cc.database_id
	INNER JOIN semanaion.c_analysis_ref a ON a.database_id = cref.database_id
		AND a.analysis_id = cref.analysis_id
WHERE
	cov.run_id = 1
"

allCategoricalCharacterizationSql <- glue(categoricalCharacterizationSql)

if(cacheAllBaselineChars && ! exists("allCategoricalCharacterizationData") && file.exists("allCategoricalCharacterizationData.rds")) {
  allCategoricalCharacterizationData <- readRDS("allCategoricalCharacterizationData.rds")
} else if(!cacheAllBaselineChars || ! exists("allCategoricalCharacterizationData") ) {
  allCategoricalCharacterizationData <- DBI::dbGetQuery(con, allCategoricalCharacterizationSql)
  saveRDS(allCategoricalCharacterizationData, "allCategoricalCharacterizationData.rds")
}


## Continuous covariates -- different columns and table
continuousCharacterizationSql <- "
SELECT
	cov.database_id,
	cov.run_id,
	t.cohort_definition_id as target_cohort_definition_id,
	t.cohort_name target_cohort_name,
	d.cdm_source_abbreviation,
	cref.covariate_name,
	cov.cohort_definition_id as covariate_cohort_definition_id,
	cov.covariate_id,
	cref.analysis_id,
	cov.count_value,
	cov.min_value,
	cov.median_value,
	cov.average_value,
	cov.max_value,
	cov.standard_deviation
FROM
	semanaion.c_covariates_continuous cov
	INNER JOIN semanaion.c_cohort_details cd ON cd.cohort_definition_id = cov.cohort_definition_id
		AND cd.database_id = cov.database_id
		AND cd.cohort_type = 'T'
	INNER JOIN semanaion.cg_cohort_definition t ON t.cohort_definition_id = cd.target_cohort_id
	INNER JOIN semanaion.c_covariate_ref cref ON cov.covariate_id = cref.covariate_id
		AND cov.database_id = cref.database_id
	INNER JOIN semanaion.database_meta_data d ON d.database_id = cov.database_id
	INNER JOIN semanaion.c_cohort_counts cc ON cov.cohort_definition_id = cc.cohort_definition_id
		AND cov.database_id = cc.database_id
	INNER JOIN semanaion.c_analysis_ref a ON a.database_id = cref.database_id
		AND a.analysis_id = cref.analysis_id
WHERE
	cov.run_id = 1
"

allContinuousCharacterizationSql <- glue(continuousCharacterizationSql)

if(cacheAllBaselineChars && !exists("allContinuousCharacterizationData") && file.exists("allContinuousCharacterizationData.rds")) {
  allContinuousCharacterizationData <- readRDS("allContinuousCharacterizationData.rds")
} else if(!exists("allContinuousCharacterizationData")) {
  allContinuousCharacterizationData <- DBI::dbGetQuery(con, allContinuousCharacterizationSql)
  saveRDS(allContinuousCharacterizationData, "allContinuousCharacterizationData.rds")
}

# Cohort counts
cohortCountSql <- "
SELECT * 
FROM cg_cohort_count
"

allCohortCountsSql <- glue(cohortCountSql)

if(cacheAllBaselineChars && !exists("allCohortCountsData") && file.exists("allCohortCountsData.rds")) {
  allCohortCountsData <- readRDS("allCohortCountsData.rds")
} else if(!exists("allCohortCountsData")) {
  allCohortCountsData <- DBI::dbGetQuery(con, allCohortCountsSql)
  saveRDS(allCohortCountsData, "allCohortCountsData.rds")
}

```

## Characterization Data

There are a handful of condition/drug covariates (of the 1000s) we want to select out.  These are from the LongTerm classifications and are selected by Dr. Cai.

```{r condition_drug_covariates,echo=FALSE}
# Now, get select condition/drug covariates
keepConditions <- c(
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Essential hypertension',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Hyperlipidemia',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Obstructive sleep apnea syndrome',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Chronic kidney disease',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Anemia',
  'drug_era group (DrugGroupEraLongTerm) during day -365 through 0 days relative to index: amiodarone',
  'drug_era group (DrugGroupEraLongTerm) during day -365 through 0 days relative to index: Interferons',
  'drug_era group (DrugGroupEraLongTerm) during day -365 through 0 days relative to index: Phosphodiesterase inhibitors'
)

conditionDrugCovariates <- allCategoricalCharacterizationData |> 
  filter(covariate_name %in% keepConditions) |> 
  select(covariate_id, covariate_name) |> 
  unique()

conditionDrugCovariateIds <- conditionDrugCovariates$covariate_id

conditionDrugCovariates |> kable()
```


```{r char_data_function,echo=FALSE}
## These are functions for easily extracting data.
extractNameFromCohortName <- function(name) {
  if_else(grepl("New user of", name), stringr::word(name, 4), name)
}

getCohortSubjectCount <- function(cohortId) {
  allCohortCountsData |> filter(cohort_id %in% cohortId) |> pull(cohort_subjects)
}

getShortCohortName <- function(cohortId, cohortName) {
  subjCount <- getCohortSubjectCount(cohortId)
  cohortName <- extractNameFromCohortName(cohortName)
  
  paste0(cohortName, " (N=", subjCount, ")")
}


standardizeResultsPivotAndOrder <- function(d, cohortIds) {
  # If a cohort id is missing, we need to add a row in 
  cohortIdsInData <- d$target_cohort_definition_id |> unique()
  cohortIdsNotInData <- setdiff(cohortIds |> as.integer(), cohortIdsInData |> as.integer())
  
  # cohortIds has named values. we want to match the missing cohort IDs to the named values
  # so we know the names of the missing cohorts
  namedCohortIdsNotInData <- cohortIds[cohortIds %in% cohortIdsNotInData]
  
  d <- d |> mutate(
    covariate_id = covariate_id |> as.character()
  )
  
  # Now, we want to add a row for each missing cohort ID
  d <- d |> 
    bind_rows(
      tibble(
        analysis_id = NA |> as.integer(),
        target_cohort_definition_id = namedCohortIdsNotInData |> as.integer(),
        short_cohort_name = stringr::str_to_lower(paste0(names(namedCohortIdsNotInData), " (N=0)")),
        covariate_id = NA |> as.character(),
        covariate_name = "missing",
        display_value = NULL
      )
    )
  
  
  # Now, for each unique value of Covariate ID, we want to pivot the data so that the Cohort names are columns
  # and underneath each column is the Value
  d <-  d |> 
    pivot_wider(
      id_cols = covariate_name,
      names_from = short_cohort_name,
      values_from = display_value,
      values_fn = list
    )
  
  # alphabetize column order by column name, except for first column, which keep in place
  covariate_name <- d |> select(1)
  cohorts <- d |> select(-1) 
  alpha_cohorts <- cohorts |> select(sort(colnames(cohorts)))
  
  d <- cbind(covariate_name, alpha_cohorts)
  
  d
}

## Categorical data by analysis Id
## combineCovariateNames lets you combine categories into a single row. provide a list of vectors of names to combine in this format:
## list(
##  "combined name" = c("name1", "name2", "name3")
## )
## 
## Please note that this depends on there being no groups with censored counts (e.g., -5), with one exception: if there is only a single group
## in the bin with data, then it is ok.
getCategoricalCharDataByAnalysisId <- function(databaseId, analysisIds = c(), cohortIds = c(), combineCovariateNames = list()) {
  
  dbCategoricalCharacterizationData <- allCategoricalCharacterizationData |> 
    filter(database_id == databaseId)

  dbCohortCountsData <- allCohortCountsData |> 
    filter(database_id == databaseId) 
  
  if(length(analysisIds) == 0) {
    d <- dbCategoricalCharacterizationData 
  } else {
    d <- dbCategoricalCharacterizationData |> filter(analysis_id %in% analysisIds)
  }

  if(length(cohortIds) > 0) {
    d <- d |> filter(target_cohort_definition_id %in% cohortIds)
  }
  
  if(length(combineCovariateNames) > 0) {
    # We need to do this per target cohorts
    target_cohort_names <- d$target_cohort_name |> unique()

    combinedGroupD <- d[0,]

    # Loop through all the target cohorts
    for(target_cohort_name_to_filter in target_cohort_names) {
      # Filter the data by the target cohort
      groupD <- d |> filter(target_cohort_name == target_cohort_name_to_filter)
      
      # Now, loop through the combineCovariateNames and combine the groups
      for(combineName in names(combineCovariateNames)) {
        combineNames <- combineCovariateNames[[combineName]]
        combineD <- groupD |> filter(covariate_name %in% combineNames)
        
        if(nrow(combineD) > 0) {
          # To get one row per analysis_id, we need to combine the data. We can do this by:
          # Recording a new covariate id, which is the combined values
          # Setting sum_value to the sum of the sum_values
          # Setting average_value to the sum of the average_values (these are percents, add them)
          combinedRow <- combinedGroupD |> 
            mutate(covariate_name = combineName)
          
          combinedRow <- combineD[1,] |> 
            mutate(covariate_name = combineName)
          
          combinedRow$covariate_id <- paste0("Combined: ", combineD |> pull(covariate_id) |> paste(collapse = ", "))
          combinedRow$sum_value <- sum(abs(combineD$sum_value))
          combinedRow$average_value <- sum(combineD$average_value)
          
          combinedGroupD <- rbind(combinedGroupD, combinedRow)
        }
      }
    }
    
    d <- combinedGroupD
  }
  
  d <- d |> 
    arrange(target_cohort_definition_id, covariate_name) |> 
    inner_join(dbCohortCountsData |> select(cohort_id, cohort_subjects), by = c("target_cohort_definition_id" = "cohort_id")) |> 
    mutate(
      short_cohort_name = paste0(extractNameFromCohortName(target_cohort_name), " (N=", cohort_subjects, ")"),
      pct = ifelse(is.na(average_value), "", round(100*average_value))
    ) |> 
    select(analysis_id, target_cohort_definition_id, short_cohort_name, covariate_id, covariate_name, sum_value, pct) |> 
    mutate(
      display_value = ifelse(is.na(pct), prettyNum(sum_value, big.mark="", scientific=FALSE), paste0(sum_value, " (", pct, ")"))
    ) |> 
    select(-sum_value, -pct)
  
  standardizeResultsPivotAndOrder(d, cohortIds)
}


## Categorical data by covariate ID
getCategoricalCharDataByCovariateId <- function(databaseId, covariateIds = c(), cohortIds = c()) {
  dbCategoricalCharacterizationData <- allCategoricalCharacterizationData |> 
    filter(database_id == databaseId)

  dbCohortCountsData <- allCohortCountsData |> 
    filter(database_id == databaseId) 
  
  if(length(covariateIds) == 0) {
    d <- dbCategoricalCharacterizationData
  } else {
    d <- dbCategoricalCharacterizationData |> filter(covariate_id %in% covariateIds)
  }

  if(length(cohortIds) > 0) {
    d <- d |> filter(target_cohort_definition_id %in% cohortIds)
  }
  
  d <- d |> 
    arrange(target_cohort_definition_id, covariate_name) |> 
    inner_join(dbCohortCountsData |> select(cohort_id, cohort_subjects), by = c("target_cohort_definition_id" = "cohort_id")) |> 
    mutate(
      short_cohort_name = paste0(extractNameFromCohortName(target_cohort_name), " (N=", cohort_subjects, ")"),
      pct = ifelse(is.na(average_value), "", round(100*average_value))
    ) |> 
    select(analysis_id, target_cohort_definition_id, short_cohort_name, covariate_id, covariate_name, sum_value, pct) |> 
    mutate(
      display_value = ifelse(is.na(pct), prettyNum(sum_value, big.mark="", scientific=FALSE), paste0(sum_value, " (", pct, ")"))
    ) |> 
    select(-sum_value, -pct)
  
  standardizeResultsPivotAndOrder(d, cohortIds)
}

## Continuous covariates by analysis id
getContinuousCharDataByAnalysisId <- function(databaseId, analysisIds = c(), cohortIds = c()) {
  
  dbContinuousCharacterizationData <- allContinuousCharacterizationData |> 
    filter(database_id == databaseId)

  dbCohortCountsData <- allCohortCountsData |> 
    filter(database_id == databaseId) 
  
  if(length(analysisIds) == 0) {
    d <- dbContinuousCharacterizationData
  } else {
    d <- dbContinuousCharacterizationData |> filter(analysis_id %in% analysisIds)
  }

  if(length(cohortIds) > 0) {
    d <- d |> filter(target_cohort_definition_id %in% cohortIds)
  }
  
  d <- d |> 
    arrange(target_cohort_definition_id, covariate_name) |> 
    inner_join(dbCohortCountsData |> select(cohort_id, cohort_subjects), by = c("target_cohort_definition_id" = "cohort_id")) |> 
    mutate(
      short_cohort_name = paste0(extractNameFromCohortName(target_cohort_name), " (N=", cohort_subjects, ")"),
      pct = ifelse(is.na(average_value), "", round(100*average_value))
    ) |> 
    select(analysis_id, target_cohort_definition_id, short_cohort_name, covariate_id, covariate_name, average_value, standard_deviation) |> 
    mutate(
      display_value = paste0(round(average_value, 2), " (", prettyNum(round(standard_deviation,2), big.mark="", scientific=FALSE), ")")
    ) |> 
    select(-average_value, -standard_deviation)
  
 standardizeResultsPivotAndOrder(d, cohortIds)
}

```

### Get data by database

```{r get-data, echo=FALSE}


ageCovariateGroups <- list(
  "age group: 0-29" = c("age group:  15 -  19", "age group:  20 -  24", "age group:  25 -  29"),
  "age group: 30-49" = c("age group:  30 -  34", "age group:  35 -  39", "age group:  40 -  44", "age group:  45 -  49"),
  "age group: 50-69" = c("age group:  50 -  54", "age group:  55 -  59", "age group:  60 -  64", "age group:  65 -  69"),
  "age group: 70+" = c("age group:  70 -  74", "age group:  75 -  79", "age group:  80 -  84", "age group:  85 -  89", "age group:  90 -  94", "age group:  95 -  99", "age group: 100 - 104", "age group: 105 - 109", "age group: 110 - 114")
      # "age group: 70-89" = c("age group:  70 -  74", "age group:  75 -  79", "age group:  80 -  84", "age group:  85 -  89"),
  # "age group: 90+" = c("age group:  90 -  94", "age group:  95 -  99", "age group: 100 - 104", "age group: 105 - 109", "age group: 110 - 114")
)

# store results in a list

allSiteCovariates <- matrix(nrow=0, ncol = 2+length(cohortIds)) |> 
  as.data.frame() |> 
  setNames(c("Database", "Covariate", sort(names(cohortIds))))

createEmptyLabelRow <- function(label, colNames) {
  labelRow <- matrix(nrow=1, ncol = 1 + emptyColumns)
  d[1,1] <- label
  d[1,2:(1+emptyColumns)] <- ""
  d <- data.frame(d)
  colnames(d) <- colNames
  d
}

addLabelRowToCovariates <- function(df, label, addBefore) {
  # First, create the label row
  labelRow <- df[0,] |> add_row()
  labelRow$covariate_name <- label
  labelRow[1,2:ncol(df)] <- "[empty]"
  
  # Find first row number in df with covariate_name containing addBefore
  rowInsertIndex <- which(stringr::str_detect(df$covariate_name, addBefore))[1]
  
  # Insert labelRow before
  df <- df |> add_row(labelRow, .before = rowInsertIndex)
  
  df
}

processCovariateGroup <- function(df, filterBy, label, replacements = list()) {
  
  newDf <- df |>
    filter(stringr::str_detect(covariate_name, filterBy)) 
  
  if(nrow(newDf) == 0) {
    return(newDf)
  }
  
  newDf <- newDf |> 
    addLabelRowToCovariates(label, filterBy) |> 
    mutate(covariate_name = stringr::str_replace(covariate_name, filterBy, ""))
  
  for(replacement in replacements) {
    newDf$covariate_name <- stringr::str_replace(newDf$covariate_name, replacement[1], replacement[2])
  }
  newDf
}

for (n in 1:nrow(databases)) {
  database <- databases[n,]
  
  # CovariateIDs:
  # 3 = Age
  # 4 = Race
  # 5 = Ethnicity
  # 902 = DCSI
  # 901 = Charlson Index
  # 903 = Chads2
  # 904 = Chads2Vasc901

  # Clean up covariates and put in order

  ageCovariatesGrouped <- getCategoricalCharDataByAnalysisId(database$database_id, c(3), cohortIds, ageCovariateGroups)
  categoricalCovariates <- getCategoricalCharDataByAnalysisId(database$database_id, c(1, 4, 5), cohortIds)
  conditionDrugCovariates <- getCategoricalCharDataByCovariateId(database$database_id, conditionDrugCovariateIds, cohortIds)
  continuousCovariates <- getContinuousCharDataByAnalysisId(database$database_id, c(902,901,903,904), cohortIds)
  
  covariatesDf <- bind_rows(
    processCovariateGroup(ageCovariatesGrouped,
                          "age group: ",
                          "Age (years)*",
                          list(c("0-29", "≤29"),
                               c("70\\+", "≥70"))),
    processCovariateGroup(categoricalCovariates,
                          "race = ",
                          "Race"),
    processCovariateGroup(categoricalCovariates,
                          "ethnicity = ",
                          "Ethnicity"),
    processCovariateGroup(categoricalCovariates,
                          "gender = ",
                          "Sex",
                          list(c("FEMALE", "Female"),
                               c("MALE", "Male"))),
    continuousCovariates |>
      filter(stringr::str_detect(covariate_name, "DCSI")) |>
      mutate(covariate_name = "DCSI (SD)&"),
    continuousCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Charlson index - Romano adaptation")
      ) |>
      mutate(covariate_name = "CCI (SD)&"),
    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Essential hypertension")
      ) |>
      mutate(covariate_name = "Essential hypertension"),
    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Hyperlipidemia")
      ) |>
      mutate(covariate_name = "Hyperlipidemia"),
    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Obstructive sleep apnea")
      ) |>
      mutate(covariate_name = "Obstructive sleep apnea"),
    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Chronic kidney disease")
      ) |>
      mutate(covariate_name = "Chronic kidney disease"),

    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Anemia")
      ) |>
      mutate(covariate_name = "Anemia"),

    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Interferon")
      ) |>
      mutate(covariate_name = "Interferon use"),

    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Amiodarone")
      ) |>
      mutate(covariate_name = "Amiodarone use"),

    conditionDrugCovariates |>
      filter(
        stringr::str_detect(covariate_name, "Phosphodiesterase")
      ) |>
      mutate(covariate_name = "Phosphodiesterase inhibitor use"),
  ) |> 
    filter(covariate_name != "missing") |> 
    mutate(database = "") |> 
    select(database, everything()) |>
    mutate(across(everything(), as.character)) |> 
    mutate(across(everything(), ~stringr::str_replace_all(., "-5 \\(0\\)", "<5 (0)"))) |>
    mutate(across(everything(), ~stringr::str_replace_all(., "-10 \\(0\\)", "<10 (0)"))) |> 
    mutate(across(everything(), ~stringr::str_replace_all(., "NULL", "0 (0)"))) |> 
    mutate(across(everything(), ~stringr::str_replace_all(., "\\[empty\\]", "")))
  
  # Prepend a row where covariate name is "n" and the values under each cohort are the Ns 
  firstRow <- data.frame(
    database = database$database_short_name,
    Covariate = "",
    covariatesDf |> select(-database, -covariate_name) |> names() |> # get what is in the parentheses after N=
      stringr::str_extract("\\((.*)\\)") |>
      stringr::str_replace_all("\\(", "") |> # strip (
      stringr::str_replace_all("\\)", "") |>  # strip 
      as.list() 
  )
  
  colnames(covariatesDf) <-  colnames(allSiteCovariates)
  colnames(firstRow) <- colnames(allSiteCovariates)
  
  siteCovariates <- rbind(firstRow, covariatesDf)

  allSiteCovariates <- rbind(allSiteCovariates, siteCovariates)
}


# Now, rearrange so cohorts are in this order:
# "Semaglutide"   "Dulaglutide"   "Exenatide"     "Empagliflozin" "Sitagliptin"   "Glipizide" 

allSiteCovariates <- allSiteCovariates |> 
  select(Database, Covariate, names(cohortIds))

allSiteCovariates |> kable()

xlsx::write.xlsx(allSiteCovariates, "results-characterization-all-sites.xlsx")
```


