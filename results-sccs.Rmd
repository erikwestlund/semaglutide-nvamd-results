---
title: "Semaglutide DR SCSS Results for Cindy et al."
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DT)
library(DBI)
library(glue)
library(kableExtra)
library(RPostgres)
library(dplyr)
library(purrr)
library(stringr)
library(tibble)
library(tidyr)
library(xlsx)


if(!file.exists("env.R")) stop("env.R not found")

source("env.R")

# Create postgres connection
con <- DBI::dbConnect(RPostgres::Postgres(), dbname = db_name, host = db_host, port = db_port, user = db_user, password = db_password,   options=paste0("-c search_path=", db_schema))

# List tables in schema
tables <- DBI::dbListTables(con, schema = db_schema)

# Database meta data and c
dbMeta <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  filter(cdm_source_abbreviation == cdmSourceAbbrev)


```

This will produce data and graphics for the Cohort Method estimation. SCSS will be put together separately.

## Databases Available

```{r databases, echo=FALSE}
databases <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  select(cdm_source_name, cdm_source_abbreviation, cdm_holder, database_id) 

databases |> kable()
```

## Database nicknames

We will map long database names to short ones for publication. Please confirm these are right.

```{r database_nicknames, echo=FALSE}


dbMap <- list(
  "Epic Legacy CUMC MERGE" = "CUMC",
  "JHME" = "JHME",
  "Merative CCAE" = "CCAE",
  "Merative MDCD" = "MDCD",
  "Merative MDCR" = "MDCR",
  "OHSU" = "OHSU",
  "Optum EHR" = "Optum® EHR",
  "OPTUM Extended SES" = "Clinformatics®",
  "PharMetrics" = "PharMetrics",
  "STARR" = "STARR",
  "USC" = "USC",
  "VA-OMOP" = "VA",
  "WashU" = "WU",
  "LRx-US9-LAAD 202405" = "IQVIA"
)

# Make df. key = col 1, val = col 2. remove row names
dbMapDf <- data.frame(
  long = names(dbMap),
  short = unlist(dbMap)
)

dbMapDf |> kable(row.names = FALSE)

# Merge in short name
databases <- databases |> 
  left_join(dbMapDf, by = c("cdm_source_abbreviation" = "long")) |> 
  rename(database_short_name = short)


dbMapOrder <- list(
  "Epic Legacy CUMC MERGE" = 3,
  "LRx-US9-LAAD 202405" = 4,
  "JHME" = 5,
  "Merative CCAE" = 1,
  "Merative MDCD" = 6,
  "Merative MDCR" = 7,
  "OHSU" = 8,
  "Optum EHR" = 9,
  "OPTUM Extended SES" = 2,
  "PharMetrics" = 10,
  "STARR" = 11,
  "USC" = 12,
  "VA-OMOP" = 13,
  "WashU" = 14
)

dbOrderDf <- data.frame(
  long = names(dbMapOrder),
  order = unlist(dbMapOrder)
)

databases <- databases |> 
  left_join(dbOrderDf, by = c("cdm_source_abbreviation" = "long")) |> 
  arrange(order)

```

## Outcomes

Outcomes:

* Specific NVAMD (Cohort ID: `1`)
* Sensitive NVAMD (Cohort ID: `2`)

## Treatment/Comparator Exposure Pairs

Exposure Cohorts:

* Semaglutide (Cohort ID: `101`)
* Dulaglutide (Cohort ID: `102`)
* Exenatide (Cohort ID: `103`)
* Empagliflozin (Cohort ID: `104`)
* Sitagliptin (Cohort ID: `105`)
* Glipizide (Cohort ID: `106`)

We want to show results for every treatment/comparator pair in the study.

```{r tcs, echo=FALSE}

outcomeIds <- c(
  "Sensitive NVAMD" = 2, 
  "Specific NVAMD" = 1  
)

cohortIds <- c(
 "Semaglutide" = 101,
 "Dulaglutide" = 102,	
 "Exenatide" = 103,
 "Empagliflozin" = 104,
 "Sitagliptin" = 105,
 "Glipizide" = 106
)

exposures <- cohortIds |> 
  enframe(name = "exposure", value = "cohort_id") |> 
  mutate(exposure = as.character(exposure))
 
exposures |> kable()

## Outcomes

outcomes <- outcomeIds |> 
  enframe(name = "outcome", value = "cohort_id") |> 
  mutate(outcome = as.character(outcome))

outcomes |> kable()

```

## Passed Diagnostics

The following diagnostics exist for every SCSS exposure by database:

* MDRR (MDRR diagnostic)
* EASE (EASE diagnostic)
* Time trend (time trend diagnostic)
* Pre-exposure (pre-exposure diagnostic)

These are stored in `sccs_diagnostics_summary`. We will visualize only those that pass all diagnostics, which we determine using the `unblind` flag.

*NOTE:* The analysis unblinds results that pass MDRR, EASE, and Time-trend diagnostics, even if pre-exposure is "NOT EVALUATED". The below results show this discrepancy.

I am not personally sure why pre-exposure is evaluated or not; we should look into this before finalizing submission.

```{r diagnostics_data, echo=FALSE}

allDiagnosticsSql <- "
  SELECT * FROM sccs_diagnostics_summary;
"

allDiagnostics <- DBI::dbGetQuery(con, allDiagnosticsSql)
```


```{r passed-diagnostics, echo=FALSE}

# We need to stich together exposures and outcomes
exposureSetSql <- "
  SELECT * FROM sccs_exposures_outcome_set
"

allExposureSets <- DBI::dbGetQuery(con, exposureSetSql)

exposureSets <- allExposureSets |> 
  filter(outcome_id %in% outcomes$cohort_id) |>
  inner_join(outcomes, by = c("outcome_id" = "cohort_id")) |>
  select(outcome, outcome_id, exposures_outcome_set_id)

sccsExposuresSql <- "
  SELECT * FROM sccs_exposure
"

allScssExposures <- DBI::dbGetQuery(con, sccsExposuresSql)

exposureOutcomePairs <- exposureSets |> 
  inner_join(allScssExposures, by = c("exposures_outcome_set_id" = "exposures_outcome_set_id")) |> 
  inner_join(exposures, by = c("era_id" = "cohort_id")) |>
  select(outcome_id, outcome, era_id, exposure, exposures_outcome_set_id) |> 
  arrange(outcome_id)


allPassedData <- allDiagnostics |> 
  mutate(
    database_id = as.character(database_id),
    exposures_outcome_set_id = as.double(exposures_outcome_set_id)
  ) |> 
  mutate(
    all_pass = mdrr_diagnostic == "PASS" & ease_diagnostic == "PASS" & time_trend_diagnostic == "PASS" & pre_exposure_diagnostic == "PASS"
  ) |> 
 filter(
   unblind == TRUE
 )

summarizedDiagnosticData <- allPassedData |> 
  filter(
    exposures_outcome_set_id %in% exposureOutcomePairs$exposures_outcome_set_id
  ) |> 
  mutate(
    database_id = as.character(database_id),
    exposures_outcome_set_id = as.double(exposures_outcome_set_id)
  ) |> 
  inner_join(exposureOutcomePairs, by = "exposures_outcome_set_id") |> 
  rename(
    outcome_name = outcome,
    exposure_name = exposure
  ) |> 
  inner_join(databases, by = "database_id")


summarizedDiagnosticDataSummary <- summarizedDiagnosticData |>
  select(
    outcome_name, database_short_name, exposure_name, mdrr_diagnostic, ease_diagnostic, time_trend_diagnostic, pre_exposure_diagnostic, all_pass, unblind
  ) |> 
  arrange(outcome_name, database_short_name, exposure_name)


summarizedDiagnosticDataSummary |> kable()
```

## Results

We will grab only data for the passed diagnostics. Reported risk ratios, CI bounds, and p-values are from **calibrated results**.

Note, again, passed diagnostics is determined by the `unblind` flag.

```{r results_data, echo=FALSE}

resultsSql <- "
  SELECT * FROM sccs_result;
"

# Only include passed diagnostics T/C Pairs
matchedResults <- DBI::dbGetQuery(con, resultsSql) |> 
  mutate(
    database_id = as.character(database_id),
    exposures_outcome_set_id = as.double(exposures_outcome_set_id)
  ) |> 
  inner_join(summarizedDiagnosticData |> select(database_id, outcome_id, outcome_name, era_id, exposures_outcome_set_id, exposure_name), by = c("database_id", "exposures_outcome_set_id")) 


rrVsCalibratedRr <- matchedResults |> 
  filter(!is.na(rr)) |> # Filter results with no RR
  select(database_id, exposures_outcome_set_id, outcome_id, era_id, rr, calibrated_rr, p, calibrated_p) |> 
  mutate(
    rr_cal_diff = rr - calibrated_rr,
    abs_rr_cal_diff = abs(rr_cal_diff),
      outcome_name = case_when(
      outcome_id == 1 ~ "Specific NVAMD",
      outcome_id == 2 ~ "Sensitive NVAMD"
    )
  ) |> 
  inner_join(summarizedDiagnosticData |> select(database_id, exposures_outcome_set_id, exposure_name), by = c("database_id", "exposures_outcome_set_id")) |> 
  inner_join(databases |> select(database_id, database_short_name), by = "database_id") |>
  select(database_short_name, outcome_name, exposure_name, rr, p, calibrated_rr, calibrated_p, rr_cal_diff, abs_rr_cal_diff)
  
  
presentationResults <-  matchedResults |> 
  mutate(
    database_id = as.character(database_id),
    era_id = as.double(era_id),
  ) |> 
  inner_join(databases, by = "database_id") |> 
  select(
    database_id, database_short_name, outcome_id, outcome_name, era_id, exposure_name, calibrated_rr, calibrated_ci_95_lb, calibrated_ci_95_ub, calibrated_p, outcome_subjects, outcome_events, outcome_observation_periods, covariate_subjects, covariate_days, covariate_eras, covariate_outcomes
  )


formatPresentationResults <- function(df) {
  df |> 
  select(
    database_short_name, outcome_name, exposure_name, outcome_subjects, outcome_events, calibrated_rr, calibrated_ci_95_lb, calibrated_ci_95_ub, calibrated_p
  ) |> 
  rename(
    "database_name" = database_short_name,
    "n" = target_subjects,
    "hr" = calibrated_rr,
    "hr_lb" = calibrated_ci_95_lb,
    "hr_ub" = calibrated_ci_95_ub,
    "p" = calibrated_p
  ) |> 
  mutate(
    hr = round(hr, 3),
    hr_lb = round(hr_lb, 3),
    hr_ub = round(hr_ub, 3),
    p = round(p, 3)
  ) |> 
  arrange(database_name, outcome_name, exposure_name, hr)
}

```

## Risk ratio vs calibrated risk ratio 

```{r rr-vs-calibrated-rr, echo=FALSE}

rrVsCalibratedRr |>
  arrange(-abs_rr_cal_diff) |>
  kable()

```

### Correlation of RR vs Calibrated RR

```{r rr-vs-calibrated-rr-correlation, echo=FALSE}
print(cor(rrVsCalibratedRr$rr, rrVsCalibratedRr$calibrated_rr))
```

### Summary of differences between RR and Calibrated RR

```{r rr-vs-calibrated-rr-diff, echo=FALSE}

summary(rrVsCalibratedRr$rr_cal_diff) 

```

## Results with passed diagnostics but no risk ratios reported

```{r display-results, echo=FALSE}

presentationResultsHasNoOutcomes <- presentationResults |> 
  filter(
    is.na(calibrated_rr)
  )

presentationResultsHasNoOutcomes |> DT::datatable(
  options = list(
    pageLength = 5
  )
)


```

## Results for exposure-outcome pairs with passed diagnostics and RRs

```{r display-results-again, echo=FALSE}

presentationResultsHasOutcomes <- presentationResults |> 
  filter(
    !is.na(calibrated_rr)
  )

presentationResultsHasOutcomes |> DT::datatable(
  options = list(
    pageLength = 20
  )
)
  
```

## Evidence Synthesis Results

To get the Bayesian random-effects synthesis, we need to pull results outs from the `es_sccs_result` table for the relevant outcomes. We only want results for those that passed diagnostics, which are saved in the `es_sccs_diagnostics_summary` table.

```{r display-es-results, echo=FALSE}

esDiagnosticSummarySql <- "
  SELECT * from es_sccs_diagnostics_summary
"

allEsDiagnosticResults <- dbGetQuery(con, esDiagnosticSummarySql) |>
  filter(exposures_outcome_set_id %in% exposureSets$exposures_outcome_set_id) |>
  mutate(
      mdrr_result = paste0(round(mdrr, 2), " (", stringr::str_to_lower(mdrr_diagnostic), ")"),
      ease_result = paste0(round(ease, 2), " (", stringr::str_to_lower(ease_diagnostic), ")"),
      tau_result = paste0(round(tau, 2), " (", stringr::str_to_lower(tau_diagnostic), ")"),
      all_pass = mdrr_diagnostic == "PASS" & ease_diagnostic == "PASS" & tau_diagnostic == "PASS"
    ) |>
  inner_join(summarizedDiagnosticData |> select(database_id, exposures_outcome_set_id, exposure_name, outcome_id, outcome_name), by = c("exposures_outcome_set_id")) 


allEsDiagnosticResultsPresentation <- allEsDiagnosticResults |>
    select(outcome_name, exposure_name, mdrr_result, ease_result, tau_result, all_pass) |>
  arrange(outcome_name, exposure_name)

allEsDiagnosticResultsPresentation |> kable()

diganosticSummary <- data.frame(
  allEsDiagnosticResults |>
    group_by(outcome_name) |>
    summarise(
      n = n(),
      n_pass = sum(all_pass),
      pass_rate = n_pass / n
    )
)

diganosticSummary |> kable()

```

We'll grab results only for passed diagnostics according to the `unblind` flag.

```{r es-results, echo=FALSE}

allEsResultsSql = "
  SELECT * from es_sccs_result
"

esResults <- dbGetQuery(con, allEsResultsSql) |>
  filter(exposures_outcome_set_id %in% exposureSets$exposures_outcome_set_id)

passedEsResults <- allEsDiagnosticResults |>
  filter(unblind == 1) |>
  inner_join(esResults |> select(-analysis_id, -covariate_id, -evidence_synthesis_analysis_id), by = c("exposures_outcome_set_id")) |> 
  select(
    outcome_id, outcome_name, exposures_outcome_set_id, exposure_name, outcome_subjects, outcome_events, outcome_observation_periods, calibrated_rr, calibrated_ci_95_lb, calibrated_ci_95_ub, calibrated_p
  )

```

## T/C Results, single table, pared down

Please note these are *calibrated* values.

```{r display-results-compact, echo=FALSE}


mainResults <- presentationResultsHasOutcomes |>
  select(
    database_id, database_short_name, outcome_id, outcome_name, exposure_name, outcome_subjects, outcome_events, outcome_observation_periods, calibrated_rr, calibrated_ci_95_lb, calibrated_ci_95_ub, calibrated_p
  ) |>
  rename(
    database_name = database_short_name,
    hr = calibrated_rr,
    hr_lb = calibrated_ci_95_lb,
    hr_ub = calibrated_ci_95_ub,
    p = calibrated_p
  )

esResults <-  passedEsResults |>
    mutate(
    database_id = "1",
    database_name = "Bayesian Synthesis",
  )  |>
  rename(
    hr = calibrated_rr,
    hr_lb = calibrated_ci_95_lb,
    hr_ub = calibrated_ci_95_ub,
    p = calibrated_p
  ) |>
   select(database_id, database_name, outcome_id, outcome_name, exposure_name, outcome_subjects, outcome_events, outcome_observation_periods, hr, hr_lb, hr_ub, p)

savedResults <- rbind(mainResults, esResults) |>
  arrange(outcome_name)


savedResults |>
  select(
    database_name, outcome_name, exposure_name, outcome_subjects, outcome_events, outcome_observation_periods, hr, hr_lb, hr_ub, p
  ) |>
  mutate(
    hr = round(hr, 2),
    hr_lb = round(hr_lb, 2),
    hr_ub = round(hr_ub, 2),
    p = round(p, 3)

  ) |>
  kable()


# Save the results
xlsx::write.xlsx(savedResults, "results-scss.xlsx")
saveRDS(savedResults, "results-scss.rds")


```