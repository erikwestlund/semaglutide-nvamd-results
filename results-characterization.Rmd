---
title: "Semaglutide DR Results for Cindy et al."
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DBI)
library(glue)
library(kableExtra)
library(RPostgres)
library(dplyr)
library(stringr)
library(tidyr)
library(xlsx)

if(!file.exists("env.R")) stop("env.R not found")

source("env.R")

cacheAllBaselineChars <- TRUE

# Notes on table prefixes:
# https://ohdsi.github.io/ShinyAppBuilder/
# cd_ = DefaultCohortDiagnostics table prefix
# cg = Cohort Table Prefix
# c = Default Characterization Prefix 
# plp = Patient Level Prediction
# cm = Cohort Method prefix
# 

# Create postgres connection
con <- DBI::dbConnect(RPostgres::Postgres(), dbname = db_name, host = db_host, port = db_port, user = db_user, password = db_password,   options=paste0("-c search_path=", db_schema))

# List tables in schema
tables <- DBI::dbListTables(con, schema = db_schema)

# Database meta data and c
dbMeta <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  filter(cdm_source_abbreviation == cdmSourceAbbrev)

databaseId <- dbMeta$database_id
```

## Databases Available

```{r databases, echo=FALSE}
databases <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  select(cdm_source_name, cdm_source_abbreviation, cdm_holder, database_id) 

databases |> kable()
```

## Selected Database

These data below are filtered for OPTUM Extended SES.

```{r selected_database, echo=FALSE}
selectedDatabase <- databases |> 
  filter(database_id == databaseId)

selectedDatabase |> kable()
```

## All Cohort Definitions in the Database

```{r cohort_definition_info, echo=FALSE}
allCohortDefinitions <- DBI::dbGetQuery(con, "SELECT * FROM cg_cohort_definition") |> 
  select(cohort_definition_id, cohort_name) 

 allCohortDefinitions |> kable()
```

# Cohorts in Table 1

We are going to select:

* Prior T2DM
* Prior metformin
* Drug exposure:
  * Semaglutide (GLP-1 RA)
  * Dulaglutide (GLP-1 RA)
  * Exenatide (GLP-1 RA)
  * Empagliflozin (SGLT2 inhibitor)
  * Sitagliptin (DPP4 inhibitor)
  * Glipizide (sulfonylurea)
* Drug used as 2nd-line treatment

These can be changed.

```{r cohorts_chosen, echo=FALSE}
cohortIds <- c(
  201, # Semaglutide
  211, # Dulaglutide
  212, # Exenatide
  213, # Empagliflozin
  214, # Sitagliptin
  215  # Glipizide
)

restrictedCohortDefs <- allCohortDefinitions |> 
  filter(cohort_definition_id %in% cohortIds)

restrictedCohortDefs |> kable()
```

## Available Covariates 

This is filtered to the selected database.

```{r available-cohort-covariates, echo=FALSE}
availableCovariates <- DBI::dbGetQuery(con, "SELECT * FROM c_analysis_ref") |> 
  filter(database_id == databaseId) |> 
  arrange(domain_id)

availableCovariates |> kable()
```

## Baseline Characteristics - Table 1 - Optum SES

```{r all_categorical_baseline_characteristics, echo=FALSE, cache=cacheAllBaselineChars}
# ## Chunkable method:
# chunkSize <- 1000
# 
categoricalCharacterizationSql <- "
SELECT
	cov.database_id,
	cov.run_id,
	t.cohort_definition_id as target_cohort_definition_id,
	t.cohort_name target_cohort_name,
	d.cdm_source_abbreviation,
	cref.covariate_name,
	cov.cohort_definition_id as covariate_cohort_definition_id,
	cov.covariate_id,
	cref.analysis_id,
	cov.sum_value,
	cov.average_value
FROM
	semanaion.c_covariates cov
	INNER JOIN semanaion.c_cohort_details cd ON cd.cohort_definition_id = cov.cohort_definition_id
		AND cd.database_id = cov.database_id
		AND cd.cohort_type = 'Target'
	INNER JOIN semanaion.cg_cohort_definition t ON t.cohort_definition_id = cd.target_cohort_id
	INNER JOIN semanaion.c_covariate_ref cref ON cov.covariate_id = cref.covariate_id
		AND cov.database_id = cref.database_id
	INNER JOIN semanaion.database_meta_data d ON d.database_id = cov.database_id
	INNER JOIN semanaion.c_cohort_counts cc ON cov.cohort_definition_id = cc.cohort_definition_id
		AND cov.database_id = cc.database_id
	INNER JOIN semanaion.c_analysis_ref a ON a.database_id = cref.database_id
		AND a.analysis_id = cref.analysis_id
WHERE
	cov.run_id = 1
	AND cov.database_id = '{databaseId}'
"

allCategoricalCharacterizationSql <- glue(categoricalCharacterizationSql)
allCategoricalCharacterizationData <- DBI::dbGetQuery(con, allCategoricalCharacterizationSql)

## Continuous covariates -- different columns and table
continuousCharacterizationSql <- "
SELECT
	cov.database_id,
	cov.run_id,
	t.cohort_definition_id as target_cohort_definition_id,
	t.cohort_name target_cohort_name,
	d.cdm_source_abbreviation,
	cref.covariate_name,
	cov.cohort_definition_id as covariate_cohort_definition_id,
	cov.covariate_id,
	cref.analysis_id,
	cov.count_value,
	cov.min_value,
	cov.median_value,
	cov.average_value,
	cov.max_value,
	cov.standard_deviation
FROM
	semanaion.c_covariates_continuous cov
	INNER JOIN semanaion.c_cohort_details cd ON cd.cohort_definition_id = cov.cohort_definition_id
		AND cd.database_id = cov.database_id
		AND cd.cohort_type = 'T'
	INNER JOIN semanaion.cg_cohort_definition t ON t.cohort_definition_id = cd.target_cohort_id
	INNER JOIN semanaion.c_covariate_ref cref ON cov.covariate_id = cref.covariate_id
		AND cov.database_id = cref.database_id
	INNER JOIN semanaion.database_meta_data d ON d.database_id = cov.database_id
	INNER JOIN semanaion.c_cohort_counts cc ON cov.cohort_definition_id = cc.cohort_definition_id
		AND cov.database_id = cc.database_id
	INNER JOIN semanaion.c_analysis_ref a ON a.database_id = cref.database_id
		AND a.analysis_id = cref.analysis_id
WHERE
	cov.run_id = 1
	AND cov.database_id = '{databaseId}'
"

allContinuousCharacterizationSql <- glue(continuousCharacterizationSql)
allContinuousCharacterizationData <- DBI::dbGetQuery(con, allContinuousCharacterizationSql)

# Cohort counts
cohortCountSql <- "
SELECT * 
FROM cg_cohort_count
WHERE database_id = '{databaseId}'
"

allCohortCountsSql <- glue(cohortCountSql)
allCohortCountsData <- DBI::dbGetQuery(con, allCohortCountsSql)

```

## Characterization Data

There are a handful of condition/drug covariates (of the 1000s) we want to select out.  These are from the LongTerm classifications and are selected by Dr. Cai.

```{r condition_drug_covariates,echo=FALSE}
# covSearchDf <- allCategoricalCharacterizationData |>
#   filter(
#     str_detect(covariate_name, regex('intravitreal injection', ignore_case = T)) |
#     str_detect(covariate_name, regex('panretinal photocoagulation', ignore_case = T)) |
#     str_detect(covariate_name, regex('focal laser', ignore_case = T)) |
#     str_detect(covariate_name, regex('diabetic retinopathy', ignore_case = T))
#   )
#       
# 
# covSearchDf |> pull(covariate_name) |> unique() |> sort()

# Now, get select condition/drug covariates
keepConditions <- c(
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Mild nonproliferative retinopathy due to diabetes mellitus',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Moderate nonproliferative retinopathy due to diabetes mellitus',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Severe nonproliferative retinopathy due to diabetes mellitus',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Proliferative retinopathy due to diabetes mellitus',
  'procedure_occurrence during day -365 through 0 days relative to index: Intravitreal injection',
  'procedure_occurrence during day -365 through 0 days relative to index: Panretinal photocoagulation',
  'procedure_occurrence during day -365 through 0 days relative to index: Focal laser photocoagulation of retina',
  'condition_era group (ConditionGroupEraLongTerm) during day -365 through 0 days relative to index: Macular edema due to diabetes mellitus'
)

conditionDrugCovariates <- allCategoricalCharacterizationData |> 
  filter(covariate_name %in% keepConditions) |> 
  select(covariate_id, covariate_name) |> 
  unique()

conditionDrugCovariateIds <- conditionDrugCovariates$covariate_id

conditionDrugCovariates |> kable()
```


```{r char_data_function,echo=FALSE}
## These are functions for easily extracting data.
extractNameFromCohortName <- function(name) {
  if_else(grepl("New user of", name), stringr::word(name, 4), name)
}

getCohortSubjectCount <- function(cohortId) {
  allCohortCountsData |> filter(cohort_id %in% cohortId) |> pull(cohort_subjects)
}

getShortCohortName <- function(cohortId, cohortName) {
  subjCount <- getCohortSubjectCount(cohortId)
  cohortName <- extractNameFromCohortName(cohortName)
  
  paste0(cohortName, " (n=", subjCount, ")")
}


## Categorical data by analysis Id
## combineCovariateNames lets you combine categories into a single row. provide a list of vectors of names to combine in this format:
## list(
##  "combined name" = c("name1", "name2", "name3")
## )
## 
## Please note that this depends on there being no groups with censored counts (e.g., -5), with one exception: if there is only a single group
## in the bin with data, then it is ok.
getCategoricalCharDataByAnalysisId <- function(analysisIds = c(), cohortIds = c(), combineCovariateNames = list()) {
  
  if(length(analysisIds) == 0) {
    d <- allCategoricalCharacterizationData
  } else {
    d <- allCategoricalCharacterizationData |> filter(analysis_id %in% analysisIds)
  }

  if(length(cohortIds) > 0) {
    d <- d |> filter(target_cohort_definition_id %in% cohortIds)
  }
  
  if(length(combineCovariateNames) > 0) {
    # We need to do this per target cohorts
    target_cohort_names <- d$target_cohort_name |> unique()

    combinedGroupD <- d[0,]

    # Loop through all the target cohorts
    for(target_cohort_name_to_filter in target_cohort_names) {
      # Filter the data by the target cohort
      groupD <- d |> filter(target_cohort_name == target_cohort_name_to_filter)
      
      # Now, loop through the combineCovariateNames and combine the groups
      for(combineName in names(combineCovariateNames)) {
        combineNames <- combineCovariateNames[[combineName]]
        combineD <- groupD |> filter(covariate_name %in% combineNames)
        
        if(nrow(combineD) > 0) {
          # To get one row per analysis_id, we need to combine the data. We can do this by:
          # Recording a new covariate id, which is the combined values
          # Setting sum_value to the sum of the sum_values
          # Setting average_value to the sum of the average_values (these are percents, add them)
          combinedRow <- combinedGroupD |> 
            mutate(covariate_name = combineName)
          
          combinedRow <- combineD[1,] |> 
            mutate(covariate_name = combineName)
          
          combinedRow$covariate_id <- paste0("Combined: ", combineD |> pull(covariate_id) |> paste(collapse = ", "))
          combinedRow$sum_value <- sum(abs(combineD$sum_value))
          combinedRow$average_value <- sum(combineD$average_value)
          
          combinedGroupD <- rbind(combinedGroupD, combinedRow)
        }
      }
    }
    
    d <- combinedGroupD
  }
  
  d <- d |> 
    arrange(target_cohort_definition_id, covariate_name) |> 
    inner_join(allCohortCountsData |> select(cohort_id, cohort_subjects), by = c("target_cohort_definition_id" = "cohort_id")) |> 
    mutate(
      short_cohort_name = paste0(extractNameFromCohortName(target_cohort_name), " (n=", cohort_subjects, ")"),
      pct = ifelse(is.na(average_value), "", round(100*average_value))
    ) |> 
    select(analysis_id, target_cohort_definition_id, short_cohort_name, covariate_id, covariate_name, sum_value, pct) |> 
    mutate(
      display_value = ifelse(is.na(pct), prettyNum(sum_value, big.mark="", scientific=FALSE), paste0(sum_value, " (", pct, ")"))
    ) |> 
    select(-sum_value, -pct)
  
  # Now, for each unique value of Covariate ID, we want to pivot the data so that the Cohort names are columns
  # and underneath each column is the Value
  d <-  d |> 
    pivot_wider(
      id_cols = covariate_name,
      names_from = short_cohort_name,
      values_from = display_value
    )
  
  d
}

## Categorical data by covariate ID
getCategoricalCharDataByCovariateId <- function(covariateIds = c(), cohortIds = c()) {
  
  if(length(covariateIds) == 0) {
    d <- allCategoricalCharacterizationData
  } else {
    d <- allCategoricalCharacterizationData |> filter(covariate_id %in% covariateIds)
  }

  if(length(cohortIds) > 0) {
    d <- d |> filter(target_cohort_definition_id %in% cohortIds)
  }
  
  d <- d |> 
    arrange(target_cohort_definition_id, covariate_name) |> 
    inner_join(allCohortCountsData |> select(cohort_id, cohort_subjects), by = c("target_cohort_definition_id" = "cohort_id")) |> 
    mutate(
      short_cohort_name = paste0(extractNameFromCohortName(target_cohort_name), " (n=", cohort_subjects, ")"),
      pct = ifelse(is.na(average_value), "", round(100*average_value))
    ) |> 
    select(analysis_id, target_cohort_definition_id, short_cohort_name, covariate_id, covariate_name, sum_value, pct) |> 
    mutate(
      display_value = ifelse(is.na(pct), prettyNum(sum_value, big.mark="", scientific=FALSE), paste0(sum_value, " (", pct, ")"))
    ) |> 
    select(-sum_value, -pct, -covariate_id)
  
  # Now, for each unique value of Covariate ID, we want to pivot the data so that the Cohort names are columns
  # and underneath each column is the Value
  d <-
    d |> 
    pivot_wider(
      id_cols = covariate_name,
      names_from = short_cohort_name,
      values_from = display_value
    )
}

## Continuous covariates by analysis id
getContinuousCharDataByAnalysisId <- function(analysisIds = c(), cohortIds = c()) {
  
  if(length(analysisIds) == 0) {
    d <- allContinuousCharacterizationData
  } else {
    d <- allContinuousCharacterizationData |> filter(analysis_id %in% analysisIds)
  }

  if(length(cohortIds) > 0) {
    d <- d |> filter(target_cohort_definition_id %in% cohortIds)
  }
  
  d <- d |> 
    arrange(target_cohort_definition_id, covariate_name) |> 
    inner_join(allCohortCountsData |> select(cohort_id, cohort_subjects), by = c("target_cohort_definition_id" = "cohort_id")) |> 
    mutate(
      short_cohort_name = paste0(extractNameFromCohortName(target_cohort_name), " (n=", cohort_subjects, ")"),
      pct = ifelse(is.na(average_value), "", round(100*average_value))
    ) |> 
    select(analysis_id, target_cohort_definition_id, short_cohort_name, covariate_id, covariate_name, average_value, standard_deviation) |> 
    mutate(
      display_value = paste0(round(average_value, 2), " (", prettyNum(round(standard_deviation,2), big.mark="", scientific=FALSE), ")")
    ) |> 
    select(-average_value, -standard_deviation)
  
  # Now, for each unique value of Covariate ID, we want to pivot the data so that the Cohort names are columns
  # and underneath each column is the Value
  d <-
    d |> 
    pivot_wider(
      id_cols = covariate_name,
      names_from = short_cohort_name,
      values_from = display_value
    )
  
  d
}

```

### Categorical covariates

Categorical covariates are shown as counts and percentages. We split age out and process separately so we can combine groups.

#### Age

Raw age data:

```{r age, echo=FALSE}

ageCovariates <- getCategoricalCharDataByAnalysisId(c(
    3 # Age
  ), 
  cohortIds
)

ageCovariates |> kable()


```

## Collapsed age data

Following antiVegf, lets collapse to: <= 29, 30-49, 50-69, 70-80, >= 90

Note that -5 means there are less than 5 patients. These cells are treated as having 5 patients. (I.e., we take the absolute value).

```{r age-collapsed, echo=FALSE}
ageCovariateGroups <- list(
  "age group: 0-29" = c("age group:  15 -  19", "age group:  20 -  24", "age group:  25 -  29"),
  "age group: 30-49" = c("age group:  30 -  34", "age group:  35 -  39", "age group:  40 -  44", "age group:  45 -  49"),
  "age group: 50-69" = c("age group:  50 -  54", "age group:  55 -  59", "age group:  60 -  64", "age group:  65 -  69"),
  "age group: 70+" = c("age group:  70 -  74", "age group:  75 -  79", "age group:  80 -  84", "age group:  85 -  89", "age group:  90 -  94", "age group:  95 -  99", "age group: 100 - 104", "age group: 105 - 109", "age group: 110 - 114")
      # "age group: 70-89" = c("age group:  70 -  74", "age group:  75 -  79", "age group:  80 -  84", "age group:  85 -  89"),
  # "age group: 90+" = c("age group:  90 -  94", "age group:  95 -  99", "age group: 100 - 104", "age group: 105 - 109", "age group: 110 - 114")
)
 
ageCovariatesGrouped <- getCategoricalCharDataByAnalysisId(c(
    3 # Age
  ), 
  cohortIds,
  ageCovariateGroups
)

ageCovariatesGrouped |> kable()
```

## Categorical covariates, excluding condition/drug values:

```{r other-categorical, echo=FALSE}

categoricalCovariates <- getCategoricalCharDataByAnalysisId(c(
    1, # Gender
    4, # Race
    5  # Ethnicity,
  ), 
  cohortIds
)

categoricalCovariates |> kable()

```

## Condition/Drug covariates

```{r conditions-drugs, echo=FALSE}

conditionDrugCovariates <- getCategoricalCharDataByCovariateId(conditionDrugCovariateIds, cohortIds)

conditionDrugCovariates |> kable()
```

## Continuous covariates

```{r continuous, echo=FALSE}

continuousCovariates <- getContinuousCharDataByAnalysisId(c(
    902, # DCSI
    901, # Charlson Index
    903, # Chads2
    904 # Chads2Vasc
  ), 
  cohortIds
)

continuousCovariates |> kable()

```

## All covariates combined

Results exported to `results-characterization.xlsx`

```{r all-covariates, echo=FALSE}

allCovariates <- bind_rows(
  ageCovariatesGrouped,
  categoricalCovariates,
  conditionDrugCovariates,
  continuousCovariates
)

allCovariates |> kable()

xlsx::write.xlsx(allCovariates, "results-characterization.xlsx")
```

