---
title: "Semaglutide DR Results for Cindy et al."
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DT)
library(DBI)
library(glue)
library(kableExtra)
library(RPostgres)
library(dplyr)
library(purrr)
library(stringr)
library(tidyr)
library(xlsx)

if(!file.exists("env.R")) stop("env.R not found")

source("env.R")

cacheAllBaselineChars <- FALSE

# Notes on table prefixes:
# https://ohdsi.github.io/ShinyAppBuilder/
# cd_ = DefaultCohortDiagnostics table prefix
# cg = Cohort Table Prefix
# c = Default Characterization Prefix 
# plp = Patient Level Prediction
# cm = Cohort Method prefix
# 

# Create postgres connection
con <- DBI::dbConnect(RPostgres::Postgres(), dbname = db_name, host = db_host, port = db_port, user = db_user, password = db_password,   options=paste0("-c search_path=", db_schema))

# List tables in schema
tables <- DBI::dbListTables(con, schema = db_schema)

# Database meta data and c
dbMeta <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  filter(cdm_source_abbreviation == cdmSourceAbbrev)

databaseId <- dbMeta$database_id
```

## Databases Available

```{r databases, echo=FALSE}
databases <- DBI::dbGetQuery(con, "SELECT * FROM database_meta_data") |> 
  select(cdm_source_name, cdm_source_abbreviation, cdm_holder, database_id) 

databases |> kable()
```

## Database nicknames

We will map long database names to short ones for publication. Please confirm these are right.

```{r database_nicknames, echo=FALSE}

dbMap <- list(
  "Epic Legacy CUMC MERGE" = "CUMC",
  "JHME" = "JHME",
  "Merative CCAE" = "CCAE",
  "Merative MDCD" = "MDCD",
  "Merative MDCR" = "MDCR",
  "OHSU" = "OHSU",
  "Optum EHR" = "Optum® EHR",
  "OPTUM Extended SES" = "Clinformatics®",
  "PharMetrics" = "PharMetrics",
  "STARR" = "STARR",
  "USC" = "USC",
  "VA-OMOP" = "VA",
  "WashU" = "WU",
  "LRx-US9-LAAD 202405" = "IQVIA"
)

# Make df. key = col 1, val = col 2. remove row names
dbMapDf <- data.frame(
  long = names(dbMap),
  short = unlist(dbMap)
)

dbMapDf |> kable(row.names = FALSE)

# Merge in short name
databases <- databases |> 
  left_join(dbMapDf, by = c("cdm_source_abbreviation" = "long")) |> 
  rename(database_short_name = short)


dbMapOrder <- list(
  "Epic Legacy CUMC MERGE" = 3,
  "LRx-US9-LAAD 202405" = 4,
  "JHME" = 5,
  "Merative CCAE" = 1,
  "Merative MDCD" = 6,
  "Merative MDCR" = 7,
  "OHSU" = 8,
  "Optum EHR" = 9,
  "OPTUM Extended SES" = 2,
  "PharMetrics" = 10,
  "STARR" = 11,
  "USC" = 12,
  "VA-OMOP" = 13,
  "WashU" = 14
)

dbOrderDf <- data.frame(
  long = names(dbMapOrder),
  order = unlist(dbMapOrder)
)

databases <- databases |> 
  left_join(dbOrderDf, by = c("cdm_source_abbreviation" = "long")) |> 
  arrange(order)

```

## All Cohort Definitions in the Database

```{r cohort_definition_info, echo=FALSE}
allCohortDefinitions <- DBI::dbGetQuery(con, "SELECT * FROM cg_cohort_definition") |> 
  select(cohort_definition_id, cohort_name) 

 allCohortDefinitions |> kable()
```

# All Cohorts Available in The Incidence Summary

The below cohorts are available in the incidence summary table.

```{r cohorts_in_incidence_summary, echo=FALSE}

cohortsInIncidenceSummary <- DBI::dbGetQuery(con, "SELECT distinct(target_cohort_definition_id) as cohort_definition_id, target_name FROM ci_incidence_summary") |> 
  arrange(cohort_definition_id)

cohortsInIncidenceSummary |> kable()
```

We are going to select:

* Prior T2DM
* Prior metformin
* Drug exposure:
  * Semaglutide (GLP-1 RA)
  * Dulaglutide (GLP-1 RA)
  * Exenatide (GLP-1 RA)
  * Empagliflozin (SGLT2 inhibitor)
  * Sitagliptin (DPP4 inhibitor)
  * Glipizide (sulfonylurea)
* Drug used as 2nd-line treatment

We will also add in the Indication cohort

These can be changed.

Note that in comparison to the characterization data, these are the base cohort Ids with no time restrictions.

```{r cohorts_chosen, echo=FALSE}
cohortIds <- c(
  17795, # Indication
  201, # Semaglutide
  211, # Dulaglutide
  212, # Exenatide
  213, # Empagliflozin
  214, # Sitagliptin
  215  # Glipizide
)

restrictedCohortDefs <- cohortsInIncidenceSummary |>
  filter(cohort_definition_id %in% cohortIds)

restrictedCohortDefs |> kable()
```


# Outcomes

The below outcomes are available in the incidence summary table:

```{r outcomes, echo=FALSE}
outcomesInIncidenceSummary <- DBI::dbGetQuery(con, "SELECT distinct(outcome_cohort_definition_id) as cohort_definition_id, outcome_name FROM ci_incidence_summary") |> 
  arrange(cohort_definition_id)

outcomesInIncidenceSummary |> kable()
```

We will be extracting incidence data for two outcomes:

* "sensitive_nvamd" specific_nvamd phenotype: Nonarteric anterior ischemic neuropathy with index date correction and 2nd dx and 2dxGCA (2)
* "specific_nvamd" specific_nvamd phenotype: Nonarteric anterior ischemic neuropathy with index date correction and 2dxGCA (1)

```{r outcomes_chosen, echo=FALSE}
outcomeIds <- c(
  2, # Sensitive NVAMD
  1  # Specific NVAMD
)

restrictedOutcomeDefs <- outcomesInIncidenceSummary |>
  filter(cohort_definition_id %in% outcomeIds)

restrictedOutcomeDefs |> kable()
```



# Incidence rates

We start by filtering the incidence summary for the selected target outcomes and exposure cohorts. Below is an example of the incidence summary table.

```{r select-all-incidence-rates, echo=FALSE}

# Easy outcome mapping
outcomeShortNames <- c(
  "2" = "Sensitive NVAMD",
  "1" = "Specific NVAMD"
)

specific_nvamdId <- 1
sensitive_nvamdId <- 2

cohortShortNames <- c(
  "17795" = "Indication Cohort",
  "201" = "Semaglutide",
  "211" = "Dulaglutide",
  "212" = "Exenatide",
  "213" = "Empagliflozin",
  "214" = "Sitagliptin",
  "215" = "Glipizide"
)

# transform outcomeIds into comma separated list
outcomeIdsString <- paste(outcomeIds, collapse = ", ")
cohortIdsString <- paste(cohortIds, collapse = ", ")
allIncidenceSql <- glue("
                        SELECT *
                        FROM ci_incidence_summary 
                        WHERE outcome_cohort_definition_id IN ({outcomeIdsString})
                            AND target_cohort_definition_id IN ({cohortIdsString})
                    ")

allIncidenceRates <- DBI::dbGetQuery(con, allIncidenceSql)

simplifyIncidenceRateResults <- function(df) {
  df |>
    select(
      database_id,
      target_cohort_definition_id,
      target_name,
      outcome_cohort_definition_id,
      outcome_name,
      age_group_name,
      gender_name,
      start_year,
      persons_at_risk,
      person_days,
      outcomes,
      person_outcomes,
      incidence_proportion_p100p,
      incidence_rate_p100py
    ) |>
    mutate(
      target_name = target_cohort_definition_id |> as.character() |> map_chr( ~cohortShortNames[.x]),
      outcome_name = outcome_cohort_definition_id |> as.character() |> map_chr( ~outcomeShortNames[.x]),
      persons_at_risk = persons_at_risk,
      person_days = person_days,
      outcomes = outcomes,
      person_outcomes = person_outcomes,
      incidence_proportion_p100000p = round(incidence_proportion_p100p * 1000, 2),
      incidence_rate_p100000py = round(incidence_rate_p100py * 100, 2)
    ) |>
    inner_join(databases |> select(database_id, cdm_source_abbreviation), by = "database_id") |>
    rename(
      database = cdm_source_abbreviation,
      target = target_name,
      outcome = outcome_name,
      target_id = target_cohort_definition_id,
      outcome_id = outcome_cohort_definition_id
    ) |> 
    select(
      database, 
      target,
      outcome, 
      age_group_name,
      gender_name,
      start_year,
      persons_at_risk,
      person_days,
      outcomes, 
      person_outcomes,
      incidence_proportion_p100000p,
      incidence_rate_p100000py
    ) |> 
    arrange(target, outcome, database)
}

allIncidenceRateSummary <- allIncidenceRates |> simplifyIncidenceRateResults()

allIncidenceRateSummary |> 
  head() |> 
  kable()

```


## Filtering by age, gender, start year == NA

To get the date for the specific cohorts, we can filter the above table for where age, gender, and start_year == `NA`.

Note, to get the proportion/rate per 100,000, I multiplied the per 100 person values in the results database by 1000: 100*1000 = 100,000.

Here's a sampling of what you get:

```{r specific-incidence-rates, echo=FALSE}

getUnconditionalIncidenceRates <- function(data) {
  data |>
  filter(
    is.na(age_id),
    is.na(gender_id),
    is.na(start_year)
  )
}

specificIncidenceRates <- allIncidenceRates |>
  getUnconditionalIncidenceRates()
  
specificIncidenceRates |> 
  simplifyIncidenceRateResults() |>
  select(-age_group_name, -gender_name, -start_year) |>
  head(20) |>
  kable()
```

## Reshaping everything

We now want a 10-column table with these columns in this order, corresponding to these data:

* Exposure
* Database
* Patients at Risk: taken from persons_at_risk_pe, which is the number of patients at risk in the exposure cohort BEFORE removing excluded time from TAR)
* On-Treatment Time (Person-Years): taken from person_days_pe, divided by 365.25, which is the number of days at risk in the exposure cohort before removing excluded time from TAR)

Then, for each outcome (specific_nvamd/sensitive_nvamd):

* Number of Outcomes
* Incidence Proportion (per 100,000 Persons)
* Incidence Rate (per 100,000 Person-Years)

Note that the table example provided has a single column for patient at risk and on-treatment time. These values only correspond when using the time before removing excluded time from TAR. See schema definitions here: https://github.com/OHDSI/CohortIncidence/blob/ac147182ced2461d515041b385962062309c473f/R/CohortIncidence.R

Please confirm this is what we want.

Please also note that after filtering for data, there are sometimes duplicates in the database. I de-duplicate that matching records and proceed if after de-duping, there are the correct number of records. There is a stop error to ensure

Note that NAs were recoded to "0" to make sorting smarter.

```{r reshape-incidence-rates-setup, echo=FALSE}

baseTable <- tribble(
  ~exposure, ~database, ~patients_at_risk_pe, ~patients_at_risk_specific_nvamd, ~on_treatment_time_years_specific_nvamd, ~outcomes_specific_nvamd, ~incidence_p100000p_specific_nvamd, ~incidence_p100000py_specific_nvamd, ~patients_at_risk_sensitive_nvamd, ~on_treatment_time_years_sensitive_nvamd, ~outcomes_sensitive_nvamd, ~incidence_p100000p_sensitive_nvamd, ~incidence_p100000py_sensitive_nvamd
)

getDataPerDatabase <- function(data, databaseId) {
  data |>
    filter(database_id == databaseId)
}

getDataPerExposure <- function(data, exposureId) {
  data |>
    filter(target_cohort_definition_id == exposureId)
}

getDataPerOutcome <- function(data, outcomeId) {
  data |>
    filter(outcome_cohort_definition_id == outcomeId)
}

prettyNumber <- function(x, roundTo = 0) {
  prettyNum(round(as.numeric(x), roundTo), big.mark = "", scientific = FALSE)
}
```

### Duplicate Data for Indication Cohort in Outcome Data

There are some databases that have duplicate for the indication cohort when grabbing outcome data for the specific/sensitive outcomes..  Lets summarize those below to see if we can identify the issue.

```{r duplicate-database-ids, echo=FALSE}
exposureId <- 17795

d <- allIncidenceRates |>
  getUnconditionalIncidenceRates() |>
  getDataPerExposure(exposureId) |> 
  arrange(database_id)

# Get database IDs
databaseIds <- unique(d$database_id)

# Create a tribble to store the duplicate database IDs
indicationIdDuplicatesData <- tribble(~database_id, ~database_name, ~has_duplicate_indication_rows, ~record_sets)
dupeRows <- data.frame()

# For each database, collect relevant data into tribble

databaseIds |> 
  walk(\(databaseId) {
    dbRow <- baseTable |> add_row()
      
  dbName <- databases |> 
    filter(database_id == databaseId) |>
    pull(cdm_source_abbreviation)
  
  rowData <- d |>
    getDataPerDatabase(databaseId) |> 
    unique()
  
  if (nrow(rowData) >2) {
    # print(paste0("More than 2 rows of outcome data for exposureId ", exposureId, " and databaseId ", databaseId, " (", dbName , ") when there should only be data for the sensitive and specific outcomes."))
    # 
    # print("Example data:")
    indicationIdDuplicatesData <<- indicationIdDuplicatesData |> add_row(database_id = databaseId, database_name = dbName, has_duplicate_indication_rows = TRUE, record_sets = nrow(rowData)/2)
    dupeRows <<- rbind(dupeRows, rowData)
  } else {
    indicationIdDuplicatesData <<- indicationIdDuplicatesData |> add_row(database_id = databaseId, database_name = dbName, has_duplicate_indication_rows = FALSE, record_sets = 1)
  }

  
})

indicationIdDuplicatesData |> kable()

```

## Duplicate Rows

```{r duplicate-rows, echo=FALSE}
dupeRows |> kable()
```

## Selecting from duplicates

In each case, there is a clear "correct" set of results, indentifiable by:

* Duplicate data is identical

Or 

* Ns reflecting database size.  Filter: `persons_at_risk_pe` > 20
* Incidence proportion/rates not NA

⛔️⚠️ **I believe it is still important to check to make sure everything with the run is correct.** ⛔️⚠ 


### Reshaped Data

The below incidence data applies above rules to handle duplciates.

```{r reshape-incidence-rates, echo=FALSE}

getIncidenceSummaryPerExposure <- function(data, exposureId) {
  # Filter the data per this exposure ID
  d <- data |>
    getUnconditionalIncidenceRates() |>
    getDataPerExposure(exposureId) |>
    arrange(database_id)

  # Get database IDs
  databaseIds <- unique(d$database_id)

  # For each database, collect relevant data into tribble
  cohortData <- databaseIds |>
    map_dfr(\(databaseId) {
      dbRow <- baseTable |> add_row()

      dbName <- databases |>
        filter(database_id == databaseId) |>
        pull(cdm_source_abbreviation)

      rowData <- d |>
        getDataPerDatabase(databaseId) |>
        unique()
      
      # If there are more than 2 rows after duping, filter out this that have persons < 20 OR NA incidence rates
      if(nrow(rowData) > 2) {
         rowData <- rowData |>
            filter(
              persons_at_risk_pe >= 20,
              !is.na(incidence_rate_p100py),
              !is.na(incidence_proportion_p100p)
            ) 
         
      }
      
      if (nrow(rowData) <= 2) {

        dbRow$exposure <- cohortShortNames[as.character(exposureId)]
  
        dbRow$database <- databases |>
          filter(database_id == databaseId) |>
          pull(cdm_source_abbreviation)
  
         # Rename to short version of db name using dMapDf
        dbRow$database <- dbMapDf |>
          filter(long == dbRow$database) |>
          pull(short)
  
        dbRow$patients_at_risk_pe <-  rowData$persons_at_risk_pe |> first()
  
        # Specific NVAMD outcome
        rowDataspecific_nvamd <- rowData |> getDataPerOutcome(specific_nvamdId)
        dbRow$patients_at_risk_specific_nvamd <- rowDataspecific_nvamd$persons_at_risk
        dbRow$on_treatment_time_years_specific_nvamd <- rowDataspecific_nvamd$person_days |> first() / 365.25
        dbRow$outcomes_specific_nvamd <- rowDataspecific_nvamd$outcomes
        dbRow$incidence_p100000p_specific_nvamd <- rowDataspecific_nvamd$incidence_proportion_p100p * 1000
        dbRow$incidence_p100000py_specific_nvamd <- rowDataspecific_nvamd$incidence_rate_p100py * 1000
  
        # Sensitive NVAMD outcome
        rowDatasensitive_nvamd <- rowData |> getDataPerOutcome(sensitive_nvamdId)
        dbRow$patients_at_risk_sensitive_nvamd <- rowDatasensitive_nvamd$persons_at_risk
        dbRow$on_treatment_time_years_sensitive_nvamd <- rowDatasensitive_nvamd$person_days |> first() / 365.25
        dbRow$outcomes_sensitive_nvamd <- rowDatasensitive_nvamd$outcomes
        dbRow$incidence_p100000p_sensitive_nvamd <- rowDatasensitive_nvamd$incidence_proportion_p100p * 1000
        dbRow$incidence_p100000py_sensitive_nvamd <- rowDatasensitive_nvamd$incidence_rate_p100py * 1000
  
        # Recode NAs to 0
        dbRow <- dbRow |> mutate(across(where(is.character), ~if_else(.x == "NA", "0", .x)))
        
        dbRow
      } else {
        NULL
        # stop("More than 2 rows of outcome data for exposureId ", exposureId, " and databaseId ", databaseId, " when there should only be data for specific_nvamd/sensitive_nvamd.")
      }
    })
  
  # Arrange by db order
  cohortData |> 
          inner_join(databases |> select(database_short_name, order), by = c("database" = "database_short_name")) |>
          arrange(order) |>
          select(-order)
}

results <- cohortIds |>
  map_dfr(\(exposureId) {
    getIncidenceSummaryPerExposure(allIncidenceRates, exposureId)
  })

presentationResults <- results |>
  rename(
    "Exposure" = "exposure",
    "Database" = "database",
    "Patients at Risk (PE)" = "patients_at_risk_pe",
    "Patients at Risk (specific_nvamd)" = "patients_at_risk_specific_nvamd",
    "Number of Outcomes (specific_nvamd)" = "outcomes_specific_nvamd",
    "On-Treatment Time (Person-Years) (specific_nvamd)" = "on_treatment_time_years_specific_nvamd",
    "Incidence Proportion (per 100,000 Persons) (specific_nvamd)" = "incidence_p100000p_specific_nvamd",
    "Incidence Rate (per 100,000 Person-Years) (specific_nvamd)" = "incidence_p100000py_specific_nvamd",
    "Patients at Risk (sensitive_nvamd)" = "patients_at_risk_sensitive_nvamd",
    "Number of Outcomes (sensitive_nvamd)" = "outcomes_sensitive_nvamd",
    "On-Treatment Time (Person-Years) (sensitive_nvamd)" = "on_treatment_time_years_sensitive_nvamd",
    "Incidence Proportion (per 100,000 Persons) (sensitive_nvamd)" = "incidence_p100000p_sensitive_nvamd",
    "Incidence Rate (per 100,000 Person-Years) (sensitive_nvamd)" = "incidence_p100000py_sensitive_nvamd"
  )

datatable(presentationResults |> mutate(across(where(is.numeric), function(x) {prettyNumber(x, 1)})), options = list(pageLength = 100))

```

## Paste-friendly Results

Results exported to `results-incidence.xlsx`

```{r google-docs-paste, echo=FALSE}
finalResults <- results |>
  select(
    exposure,
    database,
    patients_at_risk_specific_nvamd,
    on_treatment_time_years_specific_nvamd,
    outcomes_specific_nvamd,
    incidence_p100000p_specific_nvamd,
    incidence_p100000py_specific_nvamd,
    patients_at_risk_sensitive_nvamd,
    on_treatment_time_years_sensitive_nvamd,
    outcomes_sensitive_nvamd,
    incidence_p100000p_sensitive_nvamd,
    incidence_p100000py_sensitive_nvamd
  ) # |>
  # mutate(across(where(is.numeric), prettyNumber))

finalResults |>
mutate(across(where(is.numeric), function(x) {prettyNumber(x, 1)})) |>
kable()

xlsx::write.xlsx(finalResults |> mutate(across(where(is.numeric), function(x) {prettyNumber(x, 1)})), "results-incidence.xlsx")

```

## Per exposure, aggregation accross databases

Notes:

* patients at risk is summed
* on treatment time is summed
* outcomes is summed

Aggregated results exported to `results-incidence-aggregated-by-exposure.xlsx`

```{r per-exposure-patient-outcome, echo=FALSE}
aggregatedByDB <- finalResults |> 
  group_by(exposure) |> 
  mutate( # if outcomes or patients = -5 take abs
    outcomes_specific_nvamd = if_else(outcomes_specific_nvamd == -5, abs(outcomes_specific_nvamd), outcomes_specific_nvamd),
    patients_at_risk_specific_nvamd = if_else(patients_at_risk_specific_nvamd == -5, abs(patients_at_risk_specific_nvamd), patients_at_risk_specific_nvamd),
    outcomes_sensitive_nvamd = if_else(outcomes_sensitive_nvamd == -5, abs(outcomes_sensitive_nvamd), outcomes_sensitive_nvamd),
    patients_at_risk_sensitive_nvamd = if_else(patients_at_risk_sensitive_nvamd == -5, abs(patients_at_risk_sensitive_nvamd), patients_at_risk_sensitive_nvamd),
  ) |>
  summarise(
    patients_at_risk_specific_nvamd = sum(patients_at_risk_specific_nvamd),
    on_treatment_time_years_specific_nvamd = sum(on_treatment_time_years_specific_nvamd),
    outcomes_specific_nvamd = sum(outcomes_specific_nvamd),
    incidence_p100000p_specific_nvamd = mean(incidence_p100000p_specific_nvamd, na.rm = TRUE),
    incidence_p100000py_specific_nvamd = mean(incidence_p100000py_specific_nvamd, na.rm = TRUE),
    patients_at_risk_sensitive_nvamd = sum(patients_at_risk_sensitive_nvamd),
    on_treatment_time_years_sensitive_nvamd = sum(on_treatment_time_years_sensitive_nvamd),
    outcomes_sensitive_nvamd = sum(outcomes_sensitive_nvamd),
    incidence_p100000p_sensitive_nvamd = mean(incidence_p100000p_sensitive_nvamd, na.rm = TRUE),
    incidence_p100000py_sensitive_nvamd = mean(incidence_p100000py_sensitive_nvamd, na.rm = TRUE),
  ) |>
  mutate(across(where(is.numeric), function(x) {prettyNumber(x, 1)}))

aggregatedByDB |> kable()

xlsx::write.xlsx(aggregatedByDB, "results-incidence-aggregated-by-exposure.xlsx")

```